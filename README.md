# polyscript ğŸ¦€

> **Polyglot script runner** â€” Rust CLI that orchestrates **16 languages** via FFI bridges and subprocess.

[![Rust](https://img.shields.io/badge/rust-2024_edition-orange?logo=rust)](https://www.rust-lang.org/)
[![License: MIT OR Apache-2.0](https://img.shields.io/badge/license-MIT%20OR%20Apache--2.0-blue)](#license)
[![Build](https://img.shields.io/badge/build-passing-brightgreen)](#getting-started)

---

## Table of Contents

- [Overview](#overview)
- [Supported Languages](#supported-languages)
- [Architecture](#architecture)
- [Getting Started](#getting-started)
  - [Prerequisites](#prerequisites)
  - [Build](#build)
  - [Usage](#usage)
- [Subcommands](#subcommands)
- [Example Scripts](#example-scripts)
- [Data IPC â€” Passing Data Between Languages](#data-ipc--passing-data-between-languages)
- [Known Limitations](#known-limitations)
- [Project Structure](#project-structure)
- [Dependencies](#dependencies)
- [Roadmap](#roadmap)
- [License](#license)

---

## Overview

`polyscript` is a **Rust-native CLI orchestrator** that lets you invoke scripts written in any of 16 languages from a single unified command interface.

```
polyscript py   scripts/python/example.py   --  # ML / data processing (PyO3 in-process)
polyscript jl   scripts/julia/example.jl        # heavy numerical simulation
polyscript go   scripts/go/example.go           # concurrent cloud tooling
polyscript cpp  ./libexample.dylib run           # C++ shared library (libloading)
polyscript zig  scripts/zig/example.zig          # bare-metal / C replacement
# ... and 11 more
```

**Design philosophy**

| Principle | Detail |
|---|---|
| **Right tool for the job** | Each language is called only when it genuinely excels at the task |
| **Zero new files per language** | All 13 subprocess bridges are generated by two macros in one file |
| **Explicit fail-fast** | Missing runtime â†’ `command not found` immediately, no silent fallback |
| **Layered IPC** | CLI args â†’ file-path â†’ Arrow IPC, depending on data size |

---

## Supported Languages

| # | Language | Subcommand | Bridge method | Primary use case |
|---|---|---|---|---|
| 1 | ğŸ¦€ **Rust** | *(orchestrator)* | â€” | CLI routing, error propagation |
| 2 | ğŸ **Python** | `py` | PyO3 in-process FFI | ML/AI, pandas, data pipelines |
| 3 | ğŸ”¬ **Julia** | `jl` | subprocess | Numerical simulation, ODE, SciML |
| 4 | âš™ï¸ **C++** | `cpp` | libloading (dynamic load) | High-speed libs, legacy code, SIMD |
| 5 | ğŸ¹ **Go** | `go` | subprocess (`go run`) | Cloud APIs, DevOps tools, concurrent CLI |
| 6 | ğŸŒ **JavaScript** | `js` | subprocess (`node`) | I/O-bound scripts, JSON, web scraping |
| 7 | ğŸ”· **TypeScript** | `ts` | subprocess (`deno run`) | Type-safe I/O scripts, secure sandboxing |
| 8 | ğŸŒ™ **Lua** | `lua` | subprocess (`lua`) | Game scripting, embedded config, NGINX mods |
| 9 | ğŸ“Š **R** | `r` | subprocess (`Rscript`) | Statistical analysis, research visualisation |
| 10 | ğŸ”¥ **Mojo** | `mojo` | subprocess (`mojo`) | Python-compatible AI kernels, GPU ops |
| 11 | âš¡ **Zig** | `zig` | subprocess (`zig run`) | C replacement, cross-compilation |
| 12 | ğŸ”· **WebAssembly** | `wasm` | subprocess (`wasmtime run`) | Secure sandboxed plugins, edge compute |
| 13 | Î» **Haskell** | `hs` | subprocess (`runghc`) | Finance / DSL / type-safe backends |
| 14 | ğŸ **Swift** | `swift` | subprocess (`swift`) | Apple SDK, macOS-native processing |
| 15 | â˜• **Kotlin** | `kt` | subprocess (`kotlinc -script`) | JVM ecosystem, Android, Gradle DSL |
| 16 | ğŸ¦ **Nim** | `nim` | subprocess (`nim r`) | Python-syntax with C-speed, DSL generation |
| 17 | ğŸ”¬ **Fortran** | `fort` | gfortran compile + run | HPC, CFD, climate models, legacy science |

---

## Architecture

```
polyscript (Rust binary)
â”‚
â”œâ”€â”€ bridge::python   â† PyO3 (in-process, zero startup cost)
â”œâ”€â”€ bridge::cpp      â† libloading (dynamic library load)
â”‚
â””â”€â”€ bridge::*        â† generated by sp_bridge! / cr_bridge! macros
     â”œâ”€â”€ sp(cmd, pre[], script, args[])   generic subprocess runner
     â”œâ”€â”€ cr(compiler, flags[], ...)       compile â†’ temp binary â†’ run
     â”‚
     â”œâ”€â”€ sp_bridge!(julia,  "julia")
     â”œâ”€â”€ sp_bridge!(go,     "go",      "run")
     â”œâ”€â”€ sp_bridge!(js,     "node")
     â”œâ”€â”€ sp_bridge!(ts,     "deno",    "run")
     â”œâ”€â”€ sp_bridge!(lua,    "lua")
     â”œâ”€â”€ sp_bridge!(r,      "Rscript")
     â”œâ”€â”€ sp_bridge!(mojo,   "mojo")
     â”œâ”€â”€ sp_bridge!(zig,    "zig",     "run")
     â”œâ”€â”€ sp_bridge!(wasm,   "wasmtime","run")
     â”œâ”€â”€ sp_bridge!(hs,     "runghc")
     â”œâ”€â”€ sp_bridge!(swift,  "swift")
     â”œâ”€â”€ sp_bridge!(kt,     "kotlinc", "-script")
     â”œâ”€â”€ sp_bridge!(nim,    "nim",     "r")
     â””â”€â”€ cr_bridge!(fort,   "gfortran")
```

All 13 subprocess bridges are **declared in 15 lines** â€” no separate `.rs` file per language.

---

## Getting Started

### Prerequisites

#### Required (always)
- [Rust](https://rustup.rs/) 1.80+ (edition 2024)
- Python 3.x + development headers (for PyO3)

#### Optional (install only the languages you need)

| Language | Install |
|---|---|
| Julia | https://julialang.org/downloads/ |
| Go | https://go.dev/dl/ |
| Node.js | https://nodejs.org/ |
| Deno | `curl -fsSL https://deno.land/install.sh \| sh` |
| Lua | `brew install lua` / `apt install lua5.4` |
| R | https://cran.r-project.org/ |
| Mojo | https://docs.modular.com/mojo/manual/get-started |
| Zig | https://ziglang.org/download/ |
| Wasmtime | `curl https://wasmtime.dev/install.sh -sSf \| bash` |
| GHC (Haskell) | https://www.haskell.org/ghcup/ |
| Swift | https://swift.org/install/ |
| Kotlin | `brew install kotlin` / [SDKMAN](https://sdkman.io/) |
| Nim | https://nim-lang.org/install.html |
| GFortran | `brew install gcc` / `apt install gfortran` |

> **Tip â€” reproducible environment**: Use [Devbox](https://www.jetify.com/devbox/) or Docker to pin all runtimes at once (see [Roadmap](#roadmap)).

### Build

```bash
git clone https://github.com/fumishiki/polyscript
cd polyscript
cargo build --release
# binary: ./target/release/polyscript
```

### Usage

```bash
polyscript <SUBCOMMAND> <script|lib> [args...]

# Examples
polyscript py   scripts/python/example.py  arg1 arg2
polyscript jl   scripts/julia/example.jl
polyscript go   scripts/go/example.go      hello
polyscript js   scripts/js/example.js
polyscript ts   scripts/ts/example.ts
polyscript lua  scripts/lua/example.lua
polyscript r    scripts/r/example.r
polyscript mojo scripts/mojo/example.mojo
polyscript zig  scripts/zig/example.zig
polyscript wasm scripts/wasm/example.wasm
polyscript hs   scripts/haskell/example.hs
polyscript swift scripts/swift/example.swift
polyscript kt   scripts/kotlin/example.kts
polyscript nim  scripts/nim/example.nim
polyscript fort scripts/fortran/example.f90

# C++ (shared library)
cd scripts/cpp
g++ -shared -fPIC -o libexample.dylib example.cpp
polyscript cpp ./libexample.dylib run arg1
```

---

## Subcommands

```
polyscript --help
```

```
Polyglot script runner â€” 16 è¨€èªã‚’ FFI / subprocess ã§å‘¼ã³å‡ºã™

Usage: polyscript <COMMAND>

Commands:
  py     Python  (PyO3 in-process FFI)
  jl     Julia   (subprocess)
  go     Go      (go run)
  js     JavaScript (node)
  ts     TypeScript (deno run)
  lua    Lua     (lua)
  r      R       (Rscript)
  mojo   Mojo    (mojo)
  zig    Zig     (zig run)
  wasm   WebAssembly (wasmtime run)
  hs     Haskell (runghc)
  swift  Swift   (swift)
  kt     Kotlin  (kotlinc -script)
  nim    Nim     (nim r)
  fort   Fortran (gfortran compile + run)
  cpp    C++ shared library (libloading)
  help   Print this message or the help of the given subcommand(s)
```

---

## Example Scripts

Each language has a working example under `scripts/<lang>/`:

| File | What it does |
|---|---|
| `scripts/python/example.py` | Prints args via `sys.argv` |
| `scripts/julia/example.jl` | Prints `ARGS` |
| `scripts/go/example.go` | Prints `os.Args[1:]` |
| `scripts/js/example.js` | Prints `process.argv.slice(2)` |
| `scripts/ts/example.ts` | Prints `Deno.args` |
| `scripts/lua/example.lua` | Prints `arg` table |
| `scripts/r/example.r` | Prints `commandArgs(trailingOnly=TRUE)` |
| `scripts/mojo/example.mojo` | Prints `argv()[1:]` |
| `scripts/zig/example.zig` | Iterates `std.process.args()` |
| `scripts/wasm/example.wat` | WASI hello world (compile with `wat2wasm`) |
| `scripts/haskell/example.hs` | Prints `getArgs` |
| `scripts/swift/example.swift` | Prints `CommandLine.arguments.dropFirst()` |
| `scripts/kotlin/example.kts` | Prints `args.toList()` |
| `scripts/nim/example.nim` | Prints `commandLineParams()` |
| `scripts/fortran/example.f90` | Iterates `get_command_argument` |
| `scripts/cpp/example.cpp` | `extern "C" int run(argc, argv)` |

---

## Data IPC â€” Passing Data Between Languages

The current subcommand signature `<script> [args...]` passes **string arguments only**.  
For larger data, use the following layered strategy:

| Data size | Method | Notes |
|---|---|---|
| Small (flags, IDs) | CLI `[args...]` / env vars | Supported today |
| Medium (MBâ€“hundreds of MB) | **Parquet / Arrow file path** as argument | Each language reads with native libs (PyArrow, DataFrames.jl, arrow-rs) |
| Large (GB, in-process) | **Apache Arrow IPC** (shared memory / UNIX socket) | Zero-copy. Python (PyO3) and C++ (libloading) can share raw memory pointers directly |
| Streaming | stdout/stdin pipe (NDJSON / MessagePack) | Lightweight real-time use |

**Recommended pattern for ML pipelines today:**

```bash
# 1. Python writes Arrow IPC to temp file
polyscript py  preprocess.py  /data/input.parquet /tmp/features.arrow

# 2. Julia reads the Arrow file for heavy simulation
polyscript jl  simulate.jl    /tmp/features.arrow /tmp/result.arrow

# 3. Python reads result for final aggregation
polyscript py  aggregate.py   /tmp/result.arrow
```

---

## Known Limitations

### 1. Cold-start latency (subprocess languages)

| Language | Startup overhead | Severity |
|---|---|---|
| Julia | ~seconds (JIT) | ğŸ”´ High â€” avoid tight loops |
| Kotlin | ~hundreds ms (JVM) | ğŸŸ¡ Medium |
| Swift | ~hundreds ms | ğŸŸ¡ Medium |
| Go / Deno / Node | ~tens ms | ğŸŸ¢ Acceptable |
| Python (PyO3) | zero | âœ… |
| C++ (libloading) | zero | âœ… |

**Mitigations planned**: Julia â†’ `libjulia-sys` native FFI; Kotlin â†’ GraalVM Native Image; daemon mode for persistent runtimes.

### 2. Runtime dependencies

This tool requires each language's runtime to be in `$PATH`.  
A missing runtime causes an immediate, explicit error (`command not found`).  
Reproducible environment tooling (`devbox.json`, `Dockerfile`) is planned â€” see [Roadmap](#roadmap).

### 3. No structured IPC yet

Data passing is currently limited to string CLI arguments.  
Arrow IPC / Parquet path-passing is the recommended workaround for large data today.

---

## Project Structure

```
polyscript/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs               # CLI (clap derive) Â· S shared args type Â· 16-arm dispatch
â”‚   â””â”€â”€ bridge/
â”‚       â”œâ”€â”€ mod.rs            # sp() / cr() helpers + sp_bridge! / cr_bridge! macros
â”‚       â”‚                     #   â†’ inline modules: julia go js ts lua r mojo zig wasm
â”‚       â”‚                     #                     hs swift kt nim fort
â”‚       â”œâ”€â”€ python.rs         # PyO3 in-process FFI
â”‚       â”œâ”€â”€ julia.rs          # thin super::sp() wrapper (swap point for libjulia)
â”‚       â””â”€â”€ cpp.rs            # libloading dynamic library loader
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ python/example.py
â”‚   â”œâ”€â”€ julia/example.jl
â”‚   â”œâ”€â”€ cpp/example.cpp
â”‚   â”œâ”€â”€ go/example.go
â”‚   â”œâ”€â”€ js/example.js
â”‚   â”œâ”€â”€ ts/example.ts
â”‚   â”œâ”€â”€ lua/example.lua
â”‚   â”œâ”€â”€ r/example.r
â”‚   â”œâ”€â”€ mojo/example.mojo
â”‚   â”œâ”€â”€ zig/example.zig
â”‚   â”œâ”€â”€ wasm/example.wat      # compile: wat2wasm example.wat -o example.wasm
â”‚   â”œâ”€â”€ haskell/example.hs
â”‚   â”œâ”€â”€ swift/example.swift
â”‚   â”œâ”€â”€ kotlin/example.kts
â”‚   â”œâ”€â”€ nim/example.nim
â”‚   â””â”€â”€ fortran/example.f90
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ spec.md               # full design spec (gitignored â€” local only)
â””â”€â”€ Cargo.toml
```

---

## Dependencies

### Rust crates

| Crate | Version | Purpose |
|---|---|---|
| [`clap`](https://docs.rs/clap) | 4 | CLI parsing (derive feature) |
| [`pyo3`](https://pyo3.rs/) | 0.22 | Python in-process FFI |
| [`libloading`](https://docs.rs/libloading) | 0.8 | C++ shared library dynamic loading |
| [`anyhow`](https://docs.rs/anyhow) | 1 | Ergonomic error handling |

### C++ shared library convention

Functions exposed to `polyscript cpp` must follow this signature:

```cpp
extern "C" int run(int argc, const char** argv);
// returns 0 on success, non-zero on failure
```

---

## Roadmap

### Data IPC
- [ ] `--ipc-format=arrow|parquet|json` flag
- [ ] Auto-write Arrow IPC to `/tmp/polyscript_ipc_<uuid>.arrow`, pass path via `POLYSCRIPT_IPC_PATH` env var
- [ ] Zero-copy Arrow `RecordBatch` pointer sharing for Python (PyO3) and C++ (libloading)

### Cold-start mitigation
- [ ] Julia: migrate to `libjulia-sys` native FFI (in-process)
- [ ] Kotlin: GraalVM Native Image mode (AOT compiled binary)
- [ ] Daemon mode: persistent runtime over Unix socket (`--daemon` flag)

### Dependency management
- [ ] `devbox.json` â€” pin all 14 runtimes with [Devbox](https://www.jetify.com/devbox/)
- [ ] `Dockerfile` â€” all-runtimes container image
- [ ] `.mise.toml` â€” per-language version pinning

### Other
- [ ] C++: `bindgen` auto-header binding generation
- [ ] `polyscript.toml` config file for script registry
- [ ] Parallel execution mode (run multiple languages concurrently)
- [ ] WASM Component Model support (multi-language composition)

---

## License

Licensed under either of

- **MIT License** ([LICENSE-MIT](LICENSE-MIT) or https://opensource.org/licenses/MIT)
- **Apache License, Version 2.0** ([LICENSE-APACHE](LICENSE-APACHE) or https://www.apache.org/licenses/LICENSE-2.0)

at your option.

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted for inclusion in this project by you, as defined in the Apache-2.0 license, shall be dual licensed as above, without any additional terms or conditions.
